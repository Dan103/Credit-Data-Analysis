---
title: "Credit Data Report"
author: "Daniel Butynskyy"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    theme: united
---

```{r setup, include=FALSE}
# 0. SETUP ---------------------------------------------------------------------
library(tidyverse)
library(arrow)
library(RColorBrewer)   # for a consistent colour palette

# File paths
data_path <- "~/Desktop/projects/python+r/Credit Data Analysis/data/processed/credit_data_clean.parquet"

# A single harmonious palette with ≥ 8 colours
pal <- brewer.pal(8, "Set2")

# Global chunk options
knitr::opts_chunk$set(
  echo       = TRUE,
  warning    = FALSE,
  message    = FALSE,
  fig.width  = 7,
  fig.height = 5
)
```

# 1.  Data Validation

```{r data-validation}
df <- read_parquet(data_path)

cat("Rows: ", nrow(df), "\n")
cat("Columns: ", ncol(df), "\n\n")

cat("Missing values (%) per column:\n")
print(round(colMeans(is.na(df)) * 100, 2))

cat("\nDuplicate customer_id rows: ", sum(duplicated(df$customer_id)), "\n")
```

# 2.  Exploratory Data Analysis

## 2.1 Default Rate by Loan Purpose

```{r plot-default-purpose}
df1 <- df %>%
  group_by(loan_purpose) %>%
  summarise(default_rate = mean(default_12m, na.rm = TRUE) * 100) %>%
  arrange(default_rate)

ggplot(df1, aes(x = default_rate,
                y = reorder(loan_purpose, default_rate),
                fill = loan_purpose)) +
  geom_col() +
  geom_text(aes(label = paste0(round(default_rate, 1), "%")),
            hjust = -0.15, size = 3) +
  scale_fill_manual(values = pal) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.1))) +
  labs(title = "Default Rate by Loan Purpose",
       x = "Default Rate (%)", y = "Loan Purpose") +
  theme_minimal() +
  theme(legend.position = "none")
```

## 2.2 Default Rate by Credit Score Band

```{r plot-default-score-band}
df2 <- df %>%
  group_by(credit_score_band) %>%
  summarise(default_rate = mean(default_12m, na.rm = TRUE) * 100) %>%
  mutate(credit_score_band = factor(
    credit_score_band,
    levels = c("Poor","Fair","Good","Very Good","Exceptional")
  ))

ggplot(df2, aes(x = credit_score_band, y = default_rate,
                colour = credit_score_band, group = 1)) +
  geom_line(size = 1, colour = "grey50") +      # neutral line
  geom_point(size = 4) +
  geom_text(aes(label = paste0(round(default_rate, 1), "%")),
            vjust = -1.5) +
  scale_colour_manual(values = pal) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.15))) +
  labs(title = "Default Rate by Credit Score Band",
       x = "Credit Score Band", y = "Default Rate (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```

## 2.3 Default Rate by Employment Status

```{r plot-default-employment}
df3 <- df %>%
  group_by(employment_status) %>%
  summarise(default_rate = mean(default_12m, na.rm = TRUE) * 100) %>%
  arrange(default_rate)

ggplot(df3, aes(x = reorder(employment_status, default_rate),
                y = default_rate,
                fill = employment_status)) +
  geom_col() +
  geom_text(aes(label = paste0(round(default_rate, 1), "%")),
            position = position_stack(vjust = 0.5),
            colour = "white", size = 3) +
  coord_flip() +
  scale_fill_manual(values = pal) +
  labs(title = "Default Rate by Employment Status",
       x = "Employment Status", y = "Default Rate (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```

## 2.4 Default Rate by Annual Income Band

```{r plot-default-income-band}
df4 <- df %>%
  group_by(annual_income_band) %>%
  summarise(default_rate = mean(default_12m, na.rm = TRUE) * 100) %>%
  arrange(annual_income_band)

ggplot(df4, aes(x = annual_income_band, y = default_rate,
                fill = annual_income_band)) +
  geom_col() +
  geom_text(aes(label = paste0(round(default_rate, 1), "%")),
            vjust = -0.5, size = 3) +
  scale_fill_manual(values = pal) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.05))) +
  labs(title = "Default Rate by Annual Income Band",
       x = "Annual Income Band", y = "Default Rate (%)") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
```

## 2.5 Default Rate by Education Level

```{r plot-default-education}
df5 <- df %>%
  group_by(education_level) %>%
  summarise(default_rate = mean(default_12m, na.rm = TRUE) * 100) %>%
  arrange(default_rate)

ggplot(df5, aes(x = reorder(education_level, default_rate),
                y = default_rate,
                fill = education_level)) +
  geom_col() +
  geom_text(aes(label = paste0(round(default_rate, 1), "%")),
            position = position_stack(vjust = 0.5),
            colour = "white", size = 3) +
  coord_flip() +
  scale_fill_manual(values = pal) +
  labs(title = "Default Rate by Education Level",
       x = "Education Level", y = "Default Rate (%)") +
  theme_minimal() +
  theme(legend.position = "none")
```

# 3.  Conclusion

- **Validated** the cleaned dataset (row/column counts, missingness, duplicates).  
- **Explored** default rates across loan purpose, credit bands, employment status, income bands, and education levels.  



